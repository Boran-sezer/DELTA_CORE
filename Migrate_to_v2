# ================================================================
# DELTA OS - Script de Migration v1 ‚Üí v2
# ================================================================
# Migre tes donn√©es de Firebase vers Supabase
# ================================================================

import streamlit as st
from delta_memory_system import DeltaMemorySystem
import firebase_admin
from firebase_admin import credentials, firestore
import base64
import json

def migrate_from_firebase():
    """
    Migre les donn√©es de ton ancien syst√®me Firebase vers Supabase
    
    Utilise ce script UNE SEULE FOIS pour transf√©rer ta m√©moire existante
    """
    
    st.title("üîÑ Migration Delta OS v1 ‚Üí v2")
    st.markdown("---")
    
    # ================================================================
    # √âTAPE 1 : Connexion Firebase
    # ================================================================
    
    st.header("1Ô∏è‚É£ Connexion √† Firebase")
    
    if st.button("üîó Se connecter √† Firebase"):
        try:
            if not firebase_admin._apps:
                encoded = st.secrets["firebase_key"]["encoded_key"]
                cred_dict = json.loads(base64.b64decode(encoded).decode())
                cred_dict["private_key"] = cred_dict["private_key"].replace("\\n", "\n")
                cred = credentials.Certificate(cred_dict)
                firebase_admin.initialize_app(cred)
            
            db = firestore.client()
            st.success("‚úÖ Connect√© √† Firebase")
            st.session_state.firebase_db = db
            
        except Exception as e:
            st.error(f"‚ùå Erreur Firebase : {e}")
            return
    
    if "firebase_db" not in st.session_state:
        st.warning("‚ö†Ô∏è Connecte-toi d'abord √† Firebase")
        return
    
    fb_db = st.session_state.firebase_db
    
    # ================================================================
    # √âTAPE 2 : Scan Firebase
    # ================================================================
    
    st.header("2Ô∏è‚É£ Scan des donn√©es Firebase")
    
    if st.button("üîç Scanner Firebase"):
        with st.spinner("Scan en cours..."):
            
            # Scan collection jarvis_entities (si tu utilisais l'ancien syst√®me)
            try:
                entities_ref = fb_db.collection("jarvis_entities")
                entities = list(entities_ref.stream())
                
                st.success(f"‚úÖ Trouv√© {len(entities)} entit√©s")
                st.session_state.firebase_entities = entities
                
                # Affiche preview
                if entities:
                    st.subheader("Preview des entit√©s")
                    for entity in entities[:5]:
                        data = entity.to_dict()
                        st.json({entity.id: data}, expanded=False)
                
            except Exception as e:
                st.error(f"Erreur scan : {e}")
    
    if "firebase_entities" not in st.session_state:
        st.info("üëÜ Scanne d'abord les donn√©es")
        return
    
    # ================================================================
    # √âTAPE 3 : Migration vers Supabase
    # ================================================================
    
    st.header("3Ô∏è‚É£ Migration vers Supabase")
    
    entities = st.session_state.firebase_entities
    
    st.info(f"üì¶ {len(entities)} entit√©s pr√™tes √† migrer")
    
    if st.button("üöÄ LANCER LA MIGRATION", type="primary"):
        
        # Init nouveau syst√®me
        try:
            memory = DeltaMemorySystem()
            st.success("‚úÖ Syst√®me Supabase initialis√©")
        except Exception as e:
            st.error(f"‚ùå Erreur Supabase : {e}")
            return
        
        # Migration
        progress_bar = st.progress(0)
        status_text = st.empty()
        
        migrated = 0
        errors = 0
        
        for i, entity_doc in enumerate(entities):
            try:
                entity_id = entity_doc.id
                entity_data = entity_doc.to_dict()
                
                status_text.text(f"Migration de {entity_id}...")
                
                # R√©cup√®re les sous-collections (info)
                info_docs = entity_doc.reference.collection("info").stream()
                
                for info_doc in info_docs:
                    category = info_doc.id
                    facts = info_doc.to_dict()
                    
                    # Nettoie les m√©tadonn√©es Firebase
                    clean_facts = {
                        k: v for k, v in facts.items()
                        if k not in ['priority', 'last_accessed', 'access_count', 'updated_at']
                    }
                    
                    if clean_facts:
                        # Construit l'entit√© pour nouveau syst√®me
                        entity_to_store = {
                            "entity_name": entity_data.get("entity_name", entity_id),
                            "entity_type": entity_data.get("entity_type", "topic"),
                            "category": category,
                            "facts": clean_facts,
                            "priority": facts.get("priority", 2)
                        }
                        
                        # Stocke dans Supabase
                        if memory.store_entity(entity_to_store):
                            migrated += 1
                        else:
                            errors += 1
                
                # Update progress
                progress = (i + 1) / len(entities)
                progress_bar.progress(progress)
                
            except Exception as e:
                st.warning(f"‚ö†Ô∏è Erreur {entity_id}: {e}")
                errors += 1
        
        # R√©sultat
        st.markdown("---")
        st.success("‚úÖ Migration termin√©e !")
        
        col1, col2, col3 = st.columns(3)
        with col1:
            st.metric("Entit√©s trait√©es", len(entities))
        with col2:
            st.metric("Migr√©es avec succ√®s", migrated)
        with col3:
            st.metric("Erreurs", errors, delta_color="inverse")
        
        st.balloons()
        
        # Recommendations
        st.markdown("---")
        st.info("""
        ### üéâ Migration r√©ussie !
        
        **Prochaines √©tapes** :
        1. ‚úÖ Teste le nouveau syst√®me : `streamlit run delta_os_v2.py`
        2. ‚úÖ V√©rifie que tes donn√©es sont bien l√†
        3. ‚úÖ Une fois confirm√©, tu peux archiver l'ancien syst√®me Firebase
        
        **Note** : Les deux syst√®mes peuvent coexister pendant la transition.
        """)

# ================================================================
# ALTERNATIVE : Migration manuelle simple
# ================================================================

def simple_import_from_json():
    """
    Import simple depuis un fichier JSON export√©
    
    Utile si tu as d√©j√† export√© tes donn√©es
    """
    
    st.title("üì• Import depuis JSON")
    
    uploaded_file = st.file_uploader("Upload ton export JSON", type=["json"])
    
    if uploaded_file:
        try:
            data = json.load(uploaded_file)
            st.success(f"‚úÖ Fichier charg√© : {len(data)} entr√©es")
            
            st.json(data[:3], expanded=False)  # Preview
            
            if st.button("üöÄ Importer dans Supabase"):
                memory = DeltaMemorySystem()
                
                imported = 0
                for entry in data:
                    try:
                        if memory.store_entity(entry):
                            imported += 1
                    except Exception as e:
                        st.warning(f"Erreur : {e}")
                
                st.success(f"‚úÖ {imported}/{len(data)} entr√©es import√©es")
                
        except Exception as e:
            st.error(f"‚ùå Erreur : {e}")

# ================================================================
# MAIN
# ================================================================

if __name__ == "__main__":
    
    st.set_page_config(
        page_title="Migration Delta OS",
        page_icon="üîÑ",
        layout="wide"
    )
    
    tab1, tab2 = st.tabs(["üîÑ Migration Firebase", "üì• Import JSON"])
    
    with tab1:
        migrate_from_firebase()
    
    with tab2:
        simple_import_from_json()
